
interface GrainTable {
  [temp: number]: {
    [rh: number]: number;
  };
}

const EQUILIBRIUM_TABLES: { [grain: string]: GrainTable } = {
  "trigo": {
    10: { 30: 10.1, 35: 10.7, 40: 11.3, 45: 11.9, 50: 12.6, 55: 13.2, 60: 13.9, 65: 14.6, 70: 15.3, 75: 16.2, 80: 17.2, 85: 18.4, 90: 20.0 },
    12: { 30: 9.9, 35: 10.6, 40: 11.2, 45: 11.8, 50: 12.4, 55: 13.1, 60: 13.7, 65: 14.4, 70: 15.2, 75: 16.1, 80: 17.1, 85: 18.3, 90: 19.9 },
    14: { 30: 9.8, 35: 10.4, 40: 11.0, 45: 11.7, 50: 12.3, 55: 12.9, 60: 13.6, 65: 14.3, 70: 15.1, 75: 16.0, 80: 17.0, 85: 18.2, 90: 19.8 },
    16: { 30: 9.7, 35: 10.3, 40: 10.9, 45: 11.5, 50: 12.1, 55: 12.8, 60: 13.5, 65: 14.2, 70: 15.0, 75: 15.8, 80: 16.8, 85: 18.1, 90: 19.7 },
    18: { 30: 9.5, 35: 10.1, 40: 10.8, 45: 11.4, 50: 12.0, 55: 12.7, 60: 13.3, 65: 14.1, 70: 14.8, 75: 15.7, 80: 16.7, 85: 18.0, 90: 19.6 },
    20: { 30: 9.4, 35: 10.0, 40: 10.6, 45: 11.3, 50: 11.9, 55: 12.5, 60: 13.2, 65: 13.9, 70: 14.7, 75: 15.6, 80: 16.6, 85: 17.8, 90: 19.5 },
    22: { 30: 9.3, 35: 9.9, 40: 10.5, 45: 11.1, 50: 11.8, 55: 12.4, 60: 13.1, 65: 13.8, 70: 14.6, 75: 15.5, 80: 16.5, 85: 17.7, 90: 19.4 },
    24: { 30: 9.1, 35: 9.8, 40: 10.4, 45: 11.0, 50: 11.6, 55: 12.3, 60: 13.0, 65: 13.7, 70: 14.5, 75: 15.4, 80: 16.4, 85: 17.6, 90: 19.3 },
    26: { 30: 9.0, 35: 9.6, 40: 10.3, 45: 10.9, 50: 11.5, 55: 12.2, 60: 12.9, 65: 13.6, 70: 14.4, 75: 15.3, 80: 16.3, 85: 17.5, 90: 19.2 },
    28: { 30: 8.9, 35: 9.5, 40: 10.2, 45: 10.8, 50: 11.4, 55: 12.1, 60: 12.8, 65: 13.5, 70: 14.3, 75: 15.2, 80: 16.2, 85: 17.4, 90: 19.1 },
    30: { 30: 8.8, 35: 9.4, 40: 10.0, 45: 10.7, 50: 11.3, 55: 12.0, 60: 12.6, 65: 13.4, 70: 14.2, 75: 15.1, 80: 16.1, 85: 17.3, 90: 19.0 },
    32: { 30: 8.6, 35: 9.3, 40: 9.9, 45: 10.6, 50: 11.2, 55: 11.9, 60: 12.5, 65: 13.3, 70: 14.1, 75: 15.0, 80: 16.0, 85: 17.2, 90: 18.9 }
  },
  "soja": {
    10: { 30: 6.1, 35: 7.0, 40: 7.8, 45: 8.6, 50: 9.5, 55: 10.3, 60: 11.2, 65: 12.2, 70: 13.2, 75: 14.4, 80: 15.7, 85: 17.3, 90: 19.4 },
    12: { 30: 6.0, 35: 6.9, 40: 7.7, 45: 8.5, 50: 9.4, 55: 10.2, 60: 11.1, 65: 12.1, 70: 13.1, 75: 14.3, 80: 15.6, 85: 17.2, 90: 19.3 },
    14: { 30: 5.9, 35: 6.7, 40: 7.6, 45: 8.4, 50: 9.3, 55: 10.1, 60: 11.0, 65: 12.0, 70: 13.0, 75: 14.2, 80: 15.5, 85: 17.1, 90: 19.2 },
    16: { 30: 5.8, 35: 6.6, 40: 7.5, 45: 8.3, 50: 9.2, 55: 10.0, 60: 10.9, 65: 11.9, 70: 12.9, 75: 14.1, 80: 15.4, 85: 17.0, 90: 19.1 },
    18: { 30: 5.7, 35: 6.5, 40: 7.4, 45: 8.2, 50: 9.1, 55: 9.9, 60: 10.8, 65: 11.8, 70: 12.8, 75: 14.0, 80: 15.3, 85: 16.9, 90: 19.0 },
    20: { 30: 5.6, 35: 6.4, 40: 7.3, 45: 8.1, 50: 9.0, 55: 9.8, 60: 10.7, 65: 11.7, 70: 12.8, 75: 13.9, 80: 15.2, 85: 16.9, 90: 19.0 },
    22: { 30: 5.4, 35: 6.3, 40: 7.2, 45: 8.0, 50: 8.9, 55: 9.7, 60: 10.7, 65: 11.6, 70: 12.7, 75: 13.8, 80: 15.2, 85: 16.8, 90: 18.9 },
    24: { 30: 5.3, 35: 6.2, 40: 7.1, 45: 7.9, 50: 8.8, 55: 9.6, 60: 10.6, 65: 11.5, 70: 12.6, 75: 13.7, 80: 15.1, 85: 16.7, 90: 18.8 },
    26: { 30: 5.2, 35: 6.1, 40: 7.0, 45: 7.8, 50: 8.7, 55: 9.6, 60: 10.5, 65: 11.4, 70: 12.5, 75: 13.7, 80: 15.0, 85: 16.6, 90: 18.7 },
    28: { 30: 5.1, 35: 6.0, 40: 6.9, 45: 7.7, 50: 8.6, 55: 9.5, 60: 10.4, 65: 11.3, 70: 12.4, 75: 13.6, 80: 14.9, 85: 16.5, 90: 18.6 },
    30: { 30: 5.0, 35: 5.9, 40: 6.8, 45: 7.6, 50: 8.5, 55: 9.4, 60: 10.3, 65: 11.3, 70: 12.3, 75: 13.5, 80: 14.8, 85: 16.5, 90: 18.6 },
    32: { 30: 4.9, 35: 5.8, 40: 6.7, 45: 7.5, 50: 8.4, 55: 9.3, 60: 10.2, 65: 11.2, 70: 12.2, 75: 13.4, 80: 14.8, 85: 16.4, 90: 18.5 }
  },
  "maiz": {
    10: { 30: 9.9, 35: 10.6, 40: 11.2, 45: 11.8, 50: 12.5, 55: 13.1, 60: 13.8, 65: 14.6, 70: 15.4, 75: 16.3, 80: 17.3, 85: 18.6, 90: 20.3 },
    12: { 30: 9.7, 35: 10.3, 40: 11.0, 45: 11.6, 50: 12.3, 55: 12.9, 60: 13.6, 65: 14.4, 70: 15.2, 75: 16.1, 80: 17.1, 85: 18.4, 90: 20.0 },
    14: { 30: 9.4, 35: 10.1, 40: 10.7, 45: 11.4, 50: 12.0, 55: 12.7, 60: 13.4, 65: 14.2, 70: 15.0, 75: 15.9, 80: 16.9, 85: 18.2, 90: 19.9 },
    16: { 30: 9.2, 35: 9.9, 40: 10.5, 45: 11.2, 50: 11.8, 55: 12.5, 60: 13.2, 65: 14.0, 70: 14.8, 75: 15.7, 80: 16.7, 85: 18.0, 90: 19.7 },
    18: { 30: 9.0, 35: 9.7, 40: 10.3, 45: 11.0, 50: 11.6, 55: 12.3, 60: 13.0, 65: 13.8, 70: 14.6, 75: 15.5, 80: 16.6, 85: 17.9, 90: 19.5 },
    20: { 30: 8.8, 35: 9.5, 40: 10.1, 45: 10.8, 50: 11.5, 55: 12.1, 60: 12.8, 65: 13.6, 70: 14.4, 75: 15.3, 80: 16.4, 85: 17.7, 90: 19.4 },
    22: { 30: 8.6, 35: 9.3, 40: 10.0, 45: 10.6, 50: 11.3, 55: 12.0, 60: 12.7, 65: 13.4, 70: 14.3, 75: 15.2, 80: 16.2, 85: 17.5, 90: 19.2 },
    24: { 30: 8.5, 35: 9.1, 40: 9.8, 45: 10.4, 50: 11.1, 55: 11.8, 60: 12.5, 65: 13.3, 70: 14.1, 75: 15.0, 80: 16.1, 85: 17.4, 90: 19.1 },
    26: { 30: 8.3, 35: 8.9, 40: 9.6, 45: 10.3, 50: 10.9, 55: 11.6, 60: 12.3, 65: 13.1, 70: 13.9, 75: 14.9, 80: 15.9, 85: 17.2, 90: 19.0 },
    28: { 30: 8.1, 35: 8.8, 40: 9.4, 45: 10.1, 50: 10.8, 55: 11.5, 60: 12.2, 65: 12.9, 70: 13.8, 75: 14.7, 80: 15.8, 85: 17.1, 90: 18.8 },
    30: { 30: 7.9, 35: 8.6, 40: 9.3, 45: 9.9, 50: 10.6, 55: 11.3, 60: 12.0, 65: 12.8, 70: 13.6, 75: 14.6, 80: 15.6, 85: 17.0, 90: 18.7 },
    32: { 30: 7.8, 35: 8.4, 40: 9.1, 45: 9.8, 50: 10.5, 55: 11.1, 60: 11.9, 65: 12.6, 70: 13.5, 75: 14.4, 80: 15.5, 85: 16.8, 90: 18.6 }
  }
};

class EquilibriumService {
  private interpolate(x: number, x0: number, y0: number, x1: number, y1: number): number {
    if (x0 === x1) return y0;
    return y0 + (x - x0) * (y1 - y0) / (x1 - x0);
  }

  /**
   * Calcula la humedad relativa del aire de equilibrio (ERH) para una humedad de grano objetivo
   * a una temperatura de grano específica, usando interpolación bilineal inversa.
   */
  getEquilibriumHumidity(grainType: string, targetGrainMoisture: number, grainTemp: number): number | null {
    const table = EQUILIBRIUM_TABLES[grainType.toLowerCase()];
    if (!table) return null;

    const airTemps = Object.keys(table).map(Number).sort((a, b) => a - b);
    if (grainTemp < airTemps[0] || grainTemp > airTemps[airTemps.length - 1]) return null;

    const tLow = Math.max(...airTemps.filter(t => t <= grainTemp));
    const tHigh = Math.min(...airTemps.filter(t => t >= grainTemp));

    const getRhForTemp = (tempRow: { [rh: number]: number }): number | null => {
      const rhValues = Object.keys(tempRow).map(Number).sort((a, b) => a - b);
      const moistureValues = rhValues.map(rh => tempRow[rh]);

      const minMoisture = Math.min(...moistureValues);
      const maxMoisture = Math.max(...moistureValues);

      if (targetGrainMoisture < minMoisture || targetGrainMoisture > maxMoisture) return null;

      for (let i = 0; i < moistureValues.length - 1; i++) {
        const m1 = moistureValues[i];
        const m2 = moistureValues[i + 1];
        if ((m1 <= targetGrainMoisture && targetGrainMoisture <= m2) || (m2 <= targetGrainMoisture && targetGrainMoisture <= m1)) {
          return this.interpolate(targetGrainMoisture, m1, rhValues[i], m2, rhValues[i + 1]);
        }
      }
      return null;
    };

    const rhAtTLow = getRhForTemp(table[tLow]);
    const rhAtTHigh = getRhForTemp(table[tHigh]);

    if (rhAtTLow === null || rhAtTHigh === null) return null;

    return this.interpolate(grainTemp, tLow, rhAtTLow, tHigh, rhAtTHigh);
  }

  /**
   * Calcula el punto de rocío (Dew Point) dado la temperatura y humedad relativa del aire.
   * Utiliza la fórmula de Magnus-Tetens.
   */
  getDewPoint(temp: number, rh: number): number {
    const a = 17.27;
    const b = 237.7;
    const alpha = ((a * temp) / (b + temp)) + Math.log(rh / 100.0);
    return (b * alpha) / (a - alpha);
  }
}

export const equilibriumService = new EquilibriumService();
