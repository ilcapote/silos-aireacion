{% extends 'base.html' %}

{% block content %}
<div class="container mt-4" data-no-refresh>
    <h2>Historial de Heartbeats de Dispositivos ESP32</h2>
    
    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Filtros</h4>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-6">
                    <label for="establishment_id" class="form-label">Establecimiento</label>
                    <select name="establishment_id" id="establishment_id" class="form-select" onchange="this.form.submit()">
                        <option value="">Seleccionar establecimiento...</option>
                        {% for establishment in establishments %}
                        <option value="{{ establishment.id }}" 
                                {% if establishment.id == selected_establishment_id %}selected{% endif %}>
                            {{ establishment.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="time_range" class="form-label">Rango de Tiempo</label>
                    <select name="time_range" id="time_range" class="form-select" onchange="toggleDateSelector()">
                        <option value="24h" {% if time_range == '24h' %}selected{% endif %}>Últimas 24 horas</option>
                        <option value="specific_day" {% if time_range == 'specific_day' %}selected{% endif %}>Día específico</option>
                    </select>
                </div>
                <div class="col-md-3" id="date_selector_container" {% if time_range != 'specific_day' %}style="display: none;"{% endif %}>
                    <label for="selected_date" class="form-label">Fecha</label>
                    <input type="date" name="selected_date" id="selected_date" class="form-control" 
                           value="{{ selected_date }}" onchange="updateChart()">
                </div>
            </form>
        </div>
    </div>

    {% if selected_establishment_id %}
    <!-- Estado actual de dispositivos -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Estado Actual de Dispositivos</h4>
        </div>
        <div class="card-body">
            <div class="row">
                {% for device_data in heartbeat_data %}
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title">{{ device_data.mac_address }}</h6>
                            <span class="badge 
                                {% if device_data.current_status == 'online' %}bg-success
                                {% elif device_data.current_status == 'warning' %}bg-warning
                                {% else %}bg-danger{% endif %}">
                                {{ device_data.current_status|upper }}
                            </span>
                            <p class="card-text mt-2">
                                <small class="text-muted">
                                    Slots con datos: {{ device_data.received_slots }}/{{ device_data.total_slots }}
                                    <br>
                                    Slots perdidos: {{ device_data.missing_slots }}
                                    <br>
                                    Completitud: {{ "%.1f"|format((device_data.received_slots / device_data.total_slots * 100) if device_data.total_slots > 0 else 0) }}%
                                </small>
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Gráfico de heartbeats -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4>Historial de Heartbeats</h4>
            <button class="btn btn-sm btn-outline-primary" onclick="refreshChart()">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <small class="text-muted">
                    Período: {{ start_date.strftime('%Y-%m-%d %H:%M') }} - {{ end_date.strftime('%Y-%m-%d %H:%M') }}
                    <br>
                    <span class="badge bg-success me-1">●</span> Slot con heartbeat (0-20, 21-40, 41-59 min)
                    <span class="badge bg-danger me-1">●</span> Slot sin heartbeat
                    <br>
                    Grilla fija de 72 slots (3 por hora x 24 horas). Solo 1 heartbeat por slot.
                </small>
            </div>
            <div style="position: relative; height: 400px;">
                <canvas id="heartbeatChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Tabla detallada -->
    <div class="card">
        <div class="card-header">
            <h4>Detalle de Registros</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-sm" id="heartbeatTable">
                    <thead>
                        <tr>
                            <th>MAC Address</th>
                            <th>Slot de Tiempo</th>
                            <th>Timestamp Esperado</th>
                            <th>Estado</th>
                            <th>Timestamp Real</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device_data in heartbeat_data %}
                            {% for record in device_data.history %}
                            <tr class="{% if record.has_data %}table-success{% else %}table-danger{% endif %}">
                                <td>{{ device_data.mac_address }}</td>
                                <td>
                                    <span class="badge bg-info">{{ record.slot_name }}</span>
                                </td>
                                <td>{{ record.time }}</td>
                                <td>
                                    {% if record.has_data %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Con datos
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times"></i> Sin datos
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.has_data and record.actual_time %}
                                        {{ record.actual_time }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tabla de Acciones de Aireadores -->
    <div class="card mt-4">
        <div class="card-header">
            <h4><i class="fas fa-fan"></i> Acciones de Aireadores</h4>
            <small class="text-muted">Registro de encendido/apagado de aireadores en el período seleccionado</small>
        </div>
        <div class="card-body">
            {% if action_logs %}
            <div class="table-responsive">
                <table class="table table-striped table-sm" id="actionLogsTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>MAC Address</th>
                            <th>Posición Aireador</th>
                            <th>Acción</th>
                            <th>Resultado</th>
                            <th>Mensaje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in action_logs %}
                        <tr class="{% if log.result == 'success' %}table-success{% elif log.result == 'error' %}table-danger{% else %}table-warning{% endif %}">
                            <td>{{ log.timestamp }}</td>
                            <td>
                                <code>{{ log.mac_address }}</code>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ log.aerator_position }}</span>
                            </td>
                            <td>
                                {% if log.action == 'ON' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-power-off"></i> ENCENDER
                                    </span>
                                {% elif log.action == 'OFF' %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-stop"></i> APAGAR
                                    </span>
                                {% else %}
                                    <span class="badge bg-info">{{ log.action }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.result == 'success' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check"></i> Éxito
                                    </span>
                                {% elif log.result == 'error' %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-exclamation-triangle"></i> Error
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning">{{ log.result }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.message != '-' %}
                                    <small class="text-muted">{{ log.message }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Total de acciones registradas: {{ action_logs|length }}
                </small>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                No hay acciones de aireadores registradas en el período seleccionado.
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        Selecciona un establecimiento para ver el historial de heartbeats y acciones de aireadores.
    </div>
    {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
let heartbeatChart;
const heartbeatData = {{ heartbeat_data|tojson }};
const timeRange = "{{ time_range }}";

// Colores para cada dispositivo
const deviceColors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
];

function initChart() {
    const ctx = document.getElementById('heartbeatChart').getContext('2d');
    
    // Preparar datasets para cada dispositivo (datos recibidos y perdidos)
    const datasets = [];
    
    heartbeatData.forEach((deviceData, index) => {
        const baseColor = deviceColors[index % deviceColors.length];
        
        // Dataset para slots con heartbeats (puntos verdes)
        const receivedSlots = deviceData.history
            .filter(record => record.has_data)
            .map(record => ({
                x: record.timestamp_ms,
                y: index + 1,
                time: record.time,
                actual_time: record.actual_time,
                slot_name: record.slot_name,
                type: 'received'
            }));
        
        datasets.push({
            label: deviceData.mac_address + ' (Con datos)',
            data: receivedSlots,
            backgroundColor: '#28a745', // Verde para slots con datos
            borderColor: '#28a745',
            pointRadius: 5,
            pointHoverRadius: 7,
            showLine: false,
            tension: 0
        });
        
        // Dataset para slots sin heartbeats (puntos rojos)
        const missingSlots = deviceData.history
            .filter(record => !record.has_data)
            .map(record => ({
                x: record.timestamp_ms,
                y: index + 1,
                time: record.time,
                slot_name: record.slot_name,
                type: 'missing'
            }));
        
        datasets.push({
            label: deviceData.mac_address + ' (Sin datos)',
            data: missingSlots,
            backgroundColor: '#dc3545', // Rojo para slots sin datos
            borderColor: '#dc3545',
            pointRadius: 4,
            pointHoverRadius: 6,
            showLine: false,
            tension: 0
        });
    });

    heartbeatChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Historial de Heartbeats por Dispositivo'
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const date = new Date(context[0].parsed.x);
                            return date.toLocaleString('es-AR');
                        },
                        label: function(context) {
                            const point = context.raw;
                            if (point.type === 'received') {
                                return `${context.dataset.label}: Slot ${point.slot_name} - Heartbeat a las ${point.actual_time}`;
                            } else if (point.type === 'missing') {
                                return `${context.dataset.label}: Slot ${point.slot_name} - Sin heartbeat`;
                            }
                            return context.dataset.label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: timeRange === '24h' ? 'hour' : 'day',
                        displayFormats: {
                            hour: 'HH:mm',
                            day: 'MMM dd'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Tiempo'
                    }
                },
                y: {
                    type: 'linear',
                    min: 0.5,
                    max: heartbeatData.length + 0.5,
                    ticks: {
                        stepSize: 1,
                        callback: function(value, index, values) {
                            const deviceIndex = Math.round(value) - 1;
                            if (deviceIndex >= 0 && deviceIndex < heartbeatData.length) {
                                return heartbeatData[deviceIndex].mac_address;
                            }
                            return '';
                        }
                    },
                    title: {
                        display: true,
                        text: 'Dispositivos'
                    }
                }
            }
        }
    });
}

function toggleDateSelector() {
    const timeRange = document.getElementById('time_range').value;
    const dateContainer = document.getElementById('date_selector_container');
    
    if (timeRange === 'specific_day') {
        dateContainer.style.display = 'block';
        // Set default date to today if empty
        const dateInput = document.getElementById('selected_date');
        if (!dateInput.value) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        }
    } else {
        dateContainer.style.display = 'none';
    }
    
    updateChart();
}

function updateChart() {
    const establishmentId = document.getElementById('establishment_id').value;
    const timeRange = document.getElementById('time_range').value;
    const selectedDate = document.getElementById('selected_date').value;
    
    if (!establishmentId) return;
    
    // Actualizar la URL para mantener los filtros
    const url = new URL(window.location);
    url.searchParams.set('time_range', timeRange);
    if (timeRange === 'specific_day' && selectedDate) {
        url.searchParams.set('selected_date', selectedDate);
    } else {
        url.searchParams.delete('selected_date');
    }
    window.location.href = url.toString();
}

function refreshChart() {
    const establishmentId = document.getElementById('establishment_id').value;
    const timeRange = document.getElementById('time_range').value;
    
    if (!establishmentId) return;
    
    // Obtener datos actualizados vía API
    fetch(`/api/heartbeat_history_data?establishment_id=${establishmentId}&time_range=${timeRange}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Actualizar datos del gráfico
                const newDatasets = data.data.map((deviceData, index) => {
                    return {
                        label: deviceData.mac_address,
                        data: deviceData.history.map(record => ({
                            x: record.timestamp_ms,
                            y: index + 1
                        })),
                        backgroundColor: deviceColors[index % deviceColors.length],
                        borderColor: deviceColors[index % deviceColors.length],
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        showLine: false,
                        tension: 0
                    };
                });
                
                heartbeatChart.data.datasets = newDatasets;
                heartbeatChart.update();
                
                // Mostrar mensaje de éxito
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    Datos actualizados correctamente
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container').insertBefore(alert, document.querySelector('.card'));
                
                // Auto-dismiss después de 3 segundos
                setTimeout(() => {
                    alert.remove();
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error al actualizar datos:', error);
            alert('Error al actualizar los datos');
        });
}

function calculateTimeDifferences() {
    const rows = document.querySelectorAll('#heartbeatTable tbody tr');
    let lastTimestamp = null;
    
    rows.forEach(row => {
        const timestampCell = row.querySelector('.time-diff');
        const timestamp = new Date(timestampCell.dataset.timestamp);
        
        if (lastTimestamp) {
            const diffMs = timestamp - lastTimestamp;
            const diffMinutes = Math.round(diffMs / (1000 * 60));
            timestampCell.textContent = `+${diffMinutes}min`;
        } else {
            timestampCell.textContent = '-';
        }
        
        lastTimestamp = timestamp;
    });
}

// Inicializar cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    if (heartbeatData.length > 0) {
        initChart();
        calculateTimeDifferences();
    }
});
</script>

{% endblock %}
